<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>航班数据可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    <style>
        body, html {
          height: 100%;
          margin: 0;
          background-image: url('C919.png'); /* 替换成实际图片路径，如本地图片放项目目录可写"c919.jpg"，在线图片用完整URL */
          background-size: cover; /* 让背景图覆盖整个页面 */
          background-position: center; /* 背景图居中显示 */
          background-repeat: no-repeat; /* 不重复平铺 */
        }
        #chart-container {
          width: 100%;
          height: 100%;
        }
        .toolbox {
          position: absolute;
          bottom: 30px;
          left: 30px;
          background: rgba(255,255,255,0.8);
          padding: 15px 20px; /* 增加内边距，为居中布局留出空间 */
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          z-index: 100;
        }
        #selection-status {
          text-align: center; /* 状态文本居中 */
          margin-bottom: 10px; /* 状态文本与按钮间距 */
        }
        #reset-btn {
          display: block; /* 块级元素便于居中 */
          margin: 0 auto; /* 水平居中 */
          padding: 6px 12px;
          background-color: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        #reset-btn:hover {
          background-color: #0069d9;
        }
    </style>
</head>
<body>
<div id="chart-container"></div>
<div class="toolbox" id="toolbox">
    <div id="selection-status">请点击选择第一个省会城市</div>
    <button id="reset-btn">重置选择</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const chart = echarts.init(document.getElementById('chart-container'));
      const resetBtn = document.getElementById('reset-btn');
      const selectionStatus = document.getElementById('selection-status');

      const capitalCities = {
        '北京': [116.4074, 39.9042],
        '天津': [117.1901, 39.1256],
        '石家庄': [114.5149, 38.0371],
        '太原': [112.5493, 37.8572],
        '呼和浩特': [111.6707, 40.8185],
        '沈阳': [123.4290, 41.7967],
        '长春': [125.3245, 43.8868],
        '哈尔滨': [126.6425, 45.7569],
        '上海': [121.4737, 31.2304],
        '南京': [118.7674, 32.0415],
        '杭州': [120.1536, 30.2874],
        '合肥': [117.2856, 31.8612],
        '福州': [119.2959, 26.0766],
        '南昌': [115.8921, 28.6765],
        '济南': [117.0009, 36.6758],
        '郑州': [113.6654, 34.7579],
        '武汉': [114.2985, 30.5843],
        '长沙': [112.9834, 28.1127],
        '广州': [113.2806, 23.1251],
        '南宁': [108.2901, 22.8406],
        '海口': [110.3311, 20.0319],
        '重庆': [106.5049, 29.5331],
        '成都': [104.0658, 30.5728],
        '贵阳': [106.7134, 26.5784],
        '昆明': [102.7122, 25.0406],
        '拉萨': [91.1105, 29.6441],
        '西安': [108.9480, 34.2631],
        '兰州': [103.8343, 36.0611],
        '西宁': [101.7790, 36.6172],
        '银川': [106.2324, 38.4864],
        '乌鲁木齐': [87.6177, 43.8267],
        '台北': [121.5654, 25.0330]
      };

      // 初始化省会数据，添加选中状态
      const capitalData = Object.entries(capitalCities).map(([name, coords]) => ({
        name,
        value: [...coords, 10],
        selected: false // 选中状态
      }));

      // 基础配置（分离配置项，便于重置时保留）
      const baseOption = {
        title: {
           text: '中国地图',
           left: 'center',
           textStyle: {
              color:'#0000FF',
              fontSize:30,
              fontFamily: 'KaiTi',
           }
        },
        tooltip: {
          textStyle:{
             color:'#00BFFF',
             fontFamily:'KaiTi',
          },
          trigger: 'item',
          formatter: function(params) {
             return params.name
          }
        },
        geo: {
          map: 'china',
          roam: true,
          zoom: 1.2,
          itemStyle: {
            normal: { areaColor: '#f0f0f0', borderColor: '#111' },
            emphasis: { areaColor: '#e0e0e0' }
          }
        },
        series: [{
          type: 'effectScatter',
          coordinateSystem: 'geo',
          data: capitalData,
          symbolSize: 7,
          showEffectOn: 'render',
          rippleEffect: {
            brushType: 'stroke',
            color:'#00FFFF'
          },
          label: {
            show: true,
            position: 'right',
            formatter: '{b}',
            textStyle: {
              color: '#0000FF',
              fontSize: 12
            }
          },
          itemStyle: {
            color: function(params) {
              return params.data.selected ? '#FF44AA' : '#00FFFF';
            },
            shadowBlur: 10,
            shadowColor: '#333'
          },
          zlevel: 2
        }]
      };

      chart.setOption(baseOption);

      // 选中的城市（from, to）
      let selectedCities = { from: null, to: null };
      // 飞线系列ID
      const FLIGHT_SERIES_IDS = ['flight-line-static', 'flight-line-animation'];

      // 点击事件处理
      chart.on('click', function(params) {
        try {
          // 如果点击的不是省会点，或已选择两个城市，点击空白处重置
          if (params.componentType !== 'series' || params.seriesType !== 'effectScatter') {
            if (selectedCities.from || selectedCities.to) {
              resetSelection();
            }
            return;
          }

          const cityName = params.name;
          const cityData = capitalData.find(item => item.name === cityName);

          // 点击已选中的城市，取消选择
          if (cityData.selected) {
            cityData.selected = false;
            if (selectedCities.from === cityName) selectedCities.from = null;
            if (selectedCities.to === cityName) selectedCities.to = null;
            updateSelectionStatus();
            clearFlightRoutes();
            updateSeries();
            return;
          }

          // 选择第一个城市（起点）
          if (!selectedCities.from) {
            selectedCities.from = cityName;
            cityData.selected = true;
            updateSelectionStatus();
            updateSeries();
            return;
          }

          // 选择第二个城市（终点），且不是同一个城市
          if (selectedCities.from && selectedCities.from !== cityName) {
            selectedCities.to = cityName;
            cityData.selected = true;
            updateSelectionStatus();
            updateSeries();

            // 绘制飞线
            drawFlightRoute(selectedCities.from, selectedCities.to);
          } else {
            // 选择同一个城市，视为取消选择
            resetSelection();
          }
        } catch (error) {
          console.error('点击事件处理错误:', error);
          resetSelection();
        }
      });

      // 更新系列数据
      function updateSeries() {
        chart.setOption({
          series: [{
            data: capitalData
          }]
        }, {
          notMerge: false,
          silent: true
        });
      }

      // 更新选择状态显示
      function updateSelectionStatus() {
        if (!selectedCities.from) {
          selectionStatus.innerHTML = '请点击选择第一个省会城市';
        } else if (!selectedCities.to) {
          selectionStatus.innerHTML = `已选择起点: ${selectedCities.from}<br>请点击选择终点城市`;
        } else {
          selectionStatus.innerHTML = `已选择: ${selectedCities.from} → ${selectedCities.to}`;
        }
      }

      // 绘制飞线
      function drawFlightRoute(fromCity, toCity) {
        const fromCoord = capitalCities[fromCity];
        const toCoord = capitalCities[toCity];

        const flightData = [{
          fromName: fromCity,
          toName: toCity,
          coords: [fromCoord, toCoord]
        }];

        addFlightRoutes(flightData);
      }

      // 添加飞线系列
      function addFlightRoutes(flightData) {
        // 清除之前的飞线
        clearFlightRoutes();

        chart.setOption({
          series: [
            // 保留原有系列（省会标记）
            {
              type: 'effectScatter',
              coordinateSystem: 'geo',
              data: capitalData,
              symbolSize: 7,
              showEffectOn: 'render',
              rippleEffect: {
                brushType: 'stroke',
                color:'#00FFFF'
              },
              label: {
                show: true,
                position: 'right',
                formatter: '{b}',
                textStyle: {
                  color: '#0000FF',
                  fontSize: 12
                }
              },
              itemStyle: {
                color: function(params) {
                  return params.data.selected ? '#FF44AA' : '#00FFFF';
                },
                shadowBlur: 10,
                shadowColor: '#333'
              },
              zlevel: 2
            },
            // 飞线背景（静态线）
            {
              id: FLIGHT_SERIES_IDS[0],
              type: 'lines',
              coordinateSystem: 'geo',
              zlevel: 3,
              effect: { show: false },
              lineStyle: {
                color: '#999',
                width: 1,
                opacity: 0.6,
                curveness: 0.2
              },
              data: flightData
            },
            // 飞线动画
            {
              id: FLIGHT_SERIES_IDS[1],
              type: 'lines',
              coordinateSystem: 'geo',
              zlevel: 4,
              effect: {
                show: true,
                period: 4,
                trailWidth: 3,
                trailLength: 0.2,
                trailColor: '#FF44AA',
                trailOpacity: 1,
                symbol: 'circle',
                symbolSize: 5
              },
              lineStyle: {
                color: 'transparent',
                width: 0,
                curveness: 0.2
              },
              data: flightData
            }
          ]
        }, {
          notMerge: false,
          silent: true
        });
      }

      // 清除飞线系列
      function clearFlightRoutes() {
        const option = chart.getOption();
        // 通过ID移除飞线系列
        option.series = option.series.filter(series =>
          !FLIGHT_SERIES_IDS.includes(series.id || '')
        );
        chart.setOption(option, {
          notMerge: true,
          silent: true
        });
      }

      // 重置选择（修复版）
      function resetSelection() {
        // 重置选择状态
        selectedCities = { from: null, to: null };
        capitalData.forEach(item => {
          item.selected = false;
        });

        // 清除飞线
        clearFlightRoutes();

        // 恢复基础配置（关键：重新应用baseOption）
        chart.setOption(baseOption, {
          notMerge: true,
          silent: true
        });

        updateSelectionStatus();
      }

      // 重置按钮事件
      resetBtn.addEventListener('click', resetSelection);

      window.addEventListener('resize', () => chart.resize());
    });
</script>
</body>
</html>
