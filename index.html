<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>èˆªç­æ•°æ®å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    <style>
        body, html {
          height: 100%;
          margin: 0;
          background-image: url('C919.png');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
        }
        #chart-container {
          width: 100%;
          height: 100%;
        }
        .toolbox {
          position: absolute;
          bottom: 30px;
          left: 30px;
          background: rgba(255,255,255,0.8);
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          z-index: 100;
          font-family: 'KaiTi';
          max-width: 350px;
        }
        #selection-status {
          text-align: center;
          margin-bottom: 10px;
        }
        #flight-info {
          margin: 10px 0;
          padding: 10px;
          background: rgba(255,255,255,0.9);
          border-radius: 6px;
          border-left: 3px solid #FF1493;
          max-height: 200px;
          overflow-y: auto;
          display: none;
        }
        #flight-info-title {
          text-align: center;
          color: #D2691E;
          font-weight: bold;
          margin-bottom: 8px;
          font-size: 16px;
        }
        .flight-item {
          margin: 8px 0;
          padding: 5px;
          border-bottom: 1px dashed #eee;
        }
        .flight-item:last-child {
          border-bottom: none;
        }
        #reset-btn {
          display: block;
          margin: 10px auto 0;
          padding: 6px 12px;
          background-color: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-family: 'KaiTi', 'æ¥·ä½“', serif;
          font-size: 16px;
        }
        #reset-btn:hover {
          background-color: #0069d9;
        }
        .music-control {
          position: absolute;
          top: 20px;
          right: 20px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 8px 12px;
          border-radius: 4px;
          cursor: pointer;
          z-index: 200;
          display: flex;
          align-items: center;
          gap: 5px;
          font-family: 'KaiTi';
          font-size:16px;
        }
        .music-control:hover {
          background: rgba(0,0,0,0.9);
        }
    </style>
</head>
<body>
<div id="chart-container"></div>
<div class="toolbox" id="toolbox">
    <div id="selection-status">è¯·ç‚¹å‡»é€‰æ‹©ç¬¬ä¸€ä¸ªçœä¼šåŸå¸‚</div>
    <div id="flight-info">
        <div id="flight-info-title">èˆªçº¿ä¿¡æ¯</div>
        <div id="flight-list"></div>
    </div>
    <button id="reset-btn">é‡ç½®é€‰æ‹©</button>
</div>

<div class="music-control" id="music-control">
    <span id="music-icon">ğŸ”Š</span>
    <span id="music-text">æ’­æ”¾</span>
</div>

<audio id="bg-music" loop>
    <source src="Various Artists - Positive Outlook.mp3" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
</audio>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const chart = echarts.init(document.getElementById('chart-container'));
      const resetBtn = document.getElementById('reset-btn');
      const selectionStatus = document.getElementById('selection-status');
      const flightInfo = document.getElementById('flight-info');
      const flightList = document.getElementById('flight-list');
      const flightInfoTitle = document.getElementById('flight-info-title');

      // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
      const musicControl = document.getElementById('music-control');
      const musicIcon = document.getElementById('music-icon');
      const musicText = document.getElementById('music-text');
      const bgMusic = document.getElementById('bg-music');
      bgMusic.volume = 0.3;
      let musicPlayed = false;

      function handleMusicPlay() {
        if (!musicPlayed) {
          bgMusic.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e));
          musicPlayed = true;
        }
      }

      musicControl.addEventListener('click', function() {
        handleMusicPlay();
        if (bgMusic.paused) {
          bgMusic.play();
          musicIcon.textContent = 'ğŸ”Š';
          musicText.textContent = 'æ’­æ”¾';
        } else {
          bgMusic.pause();
          musicIcon.textContent = 'ğŸ”‡';
          musicText.textContent = 'æš‚åœ';
        }
      });

      // çœä¼šåŸå¸‚åæ ‡
      const capitalCities = {
        'åŒ—äº¬': [116.4074, 39.9042],
        'å¤©æ´¥': [117.1901, 39.1256],
        'çŸ³å®¶åº„': [114.5149, 38.0371],
        'å¤ªåŸ': [112.5493, 37.8572],
        'å‘¼å’Œæµ©ç‰¹': [111.6707, 40.8185],
        'æ²ˆé˜³': [123.4290, 41.7967],
        'é•¿æ˜¥': [125.3245, 43.8868],
        'å“ˆå°”æ»¨': [126.6425, 45.7569],
        'ä¸Šæµ·': [121.4737, 31.2304],
        'å—äº¬': [118.7674, 32.0415],
        'æ­å·': [120.1536, 30.2874],
        'åˆè‚¥': [117.2856, 31.8612],
        'ç¦å·': [119.2959, 26.0766],
        'å—æ˜Œ': [115.8921, 28.6765],
        'æµå—': [117.0009, 36.6758],
        'éƒ‘å·': [113.6654, 34.7579],
        'æ­¦æ±‰': [114.2985, 30.5843],
        'é•¿æ²™': [112.9834, 28.1127],
        'å¹¿å·': [113.2806, 23.1251],
        'å—å®': [108.2901, 22.8406],
        'æµ·å£': [110.3311, 20.0319],
        'é‡åº†': [106.5049, 29.5331],
        'æˆéƒ½': [104.0658, 30.5728],
        'è´µé˜³': [106.7134, 26.5784],
        'æ˜†æ˜': [102.7122, 25.0406],
        'æ‹‰è¨': [91.1105, 29.6441],
        'è¥¿å®‰': [108.9480, 34.2631],
        'å…°å·': [103.8343, 36.0611],
        'è¥¿å®': [101.7790, 36.6172],
        'é“¶å·': [106.2324, 38.4864],
        'ä¹Œé²æœ¨é½': [87.6177, 43.8267],
        'å°åŒ—': [121.5654, 25.0330]
      };

      // 6æœˆ30æ—¥è´µé˜³-æ­å·åŠæ­å·-è´µé˜³èˆªç­æ•°æ®ï¼ˆå·²å»é™¤ä»·æ ¼ä¿¡æ¯ï¼‰
      const flightRoutes = {
        'è´µé˜³-æ­å·': [
          {
            flightNo: 'CZ3687',
            airline: 'å—æ–¹èˆªç©º',
            departureTime: '08:25',
            arrivalTime: '10:40',
            aircraft: 'æ³¢éŸ³737-800',
            status: 'å‡†ç‚¹'
          },
          {
            flightNo: 'CZ6175',
            airline: 'å—æ–¹èˆªç©º',
            departureTime: '14:10',
            arrivalTime: '16:20',
            aircraft: 'ç©ºå®¢A320',
            status: 'å‡†ç‚¹'
          },
          {
            flightNo: 'GJ8765',
            airline: 'é•¿é¾™èˆªç©º',
            departureTime: '16:55',
            arrivalTime: '19:10',
            aircraft: 'ç©ºå®¢A320neo',
            status: 'å»¶è¯¯30åˆ†é’Ÿ'
          },
          {
            flightNo: 'CZ3863',
            airline: 'å—æ–¹èˆªç©º',
            departureTime: '19:35',
            arrivalTime: '21:50',
            aircraft: 'æ³¢éŸ³737-800',
            status: 'å‡†ç‚¹'
          }
        ],
        'æ­å·-è´µé˜³': [
          {
            flightNo: 'CZ3688',
            airline: 'å—æ–¹èˆªç©º',
            departureTime: '11:30',
            arrivalTime: '13:45',
            aircraft: 'æ³¢éŸ³737-800',
            status: 'å‡†ç‚¹'
          },
          {
            flightNo: 'GJ8766',
            airline: 'é•¿é¾™èˆªç©º',
            departureTime: '12:45',
            arrivalTime: '15:00',
            aircraft: 'ç©ºå®¢A320neo',
            status: 'å‡†ç‚¹'
          },
          {
            flightNo: 'CZ6176',
            airline: 'å—æ–¹èˆªç©º',
            departureTime: '17:10',
            arrivalTime: '19:25',
            aircraft: 'ç©ºå®¢A320',
            status: 'å»¶è¯¯15åˆ†é’Ÿ'
          },
          {
            flightNo: 'MU5479',
            airline: 'ä¸œæ–¹èˆªç©º',
            departureTime: '20:05',
            arrivalTime: '22:20',
            aircraft: 'æ³¢éŸ³737-800',
            status: 'å‡†ç‚¹'
          }
        ]
      };

      // åˆå§‹åŒ–çœä¼šæ•°æ®
      const capitalData = Object.entries(capitalCities).map(([name, coords]) => ({
        name,
        value: [...coords, 10],
        selected: false
      }));

      // å›¾è¡¨åŸºç¡€é…ç½®
      const baseOption = {
        title: {
           text: '6æœˆ30æ—¥èˆªç­æ•°æ®',
           left: 'center',
           textStyle: {
              color:'#0000FF',
              fontSize:30,
              fontFamily: 'KaiTi',
           }
        },
        tooltip: {
          textStyle:{
             color:'#00BFFF',
             fontFamily:'KaiTi',
          },
          trigger: 'item',
          formatter: params => params.name
        },
        geo: {
          map: 'china',
          roam: true,
          zoom: 1.2,
          itemStyle: {
            normal: { areaColor: '#f0f0f0', borderColor: '#111' },
            emphasis: { areaColor: '#e0e0e0' }
          }
        },
        series: [{
          type: 'effectScatter',
          coordinateSystem: 'geo',
          data: capitalData,
          symbolSize: 7,
          showEffectOn: 'render',
          rippleEffect: {
            brushType: 'stroke',
            color:'#00FFFF'
          },
          label: {
            show: true,
            position: 'right',
            formatter: '{b}',
            textStyle: {
              color: '#0000FF',
              fontSize: 12
            }
          },
          itemStyle: {
            color: params => params.data.selected ? '#FF44AA' : '#00FFFF',
            shadowBlur: 10,
            shadowColor: '#333'
          },
          zlevel: 2
        }]
      };

      chart.setOption(baseOption);

      // é€‰ä¸­åŸå¸‚çŠ¶æ€
      let selectedCities = { from: null, to: null };
      const FLIGHT_SERIES_IDS = ['flight-line-static', 'flight-line-animation'];

      // ç‚¹å‡»äº‹ä»¶å¤„ç†
      chart.on('click', function(params) {
        try {
          if (params.componentType !== 'series' || params.seriesType !== 'effectScatter') {
            if (selectedCities.from || selectedCities.to) resetSelection();
            return;
          }

          const cityName = params.name;
          const cityData = capitalData.find(item => item.name === cityName);

          // å–æ¶ˆé€‰ä¸­
          if (cityData.selected) {
            cityData.selected = false;
            if (selectedCities.from === cityName) selectedCities.from = null;
            if (selectedCities.to === cityName) selectedCities.to = null;
            updateSelectionStatus();
            clearFlightRoutes();
            updateSeries();
            hideFlightInfo();
            return;
          }

          // é€‰æ‹©èµ·ç‚¹
          if (!selectedCities.from) {
            selectedCities.from = cityName;
            cityData.selected = true;
            updateSelectionStatus();
            updateSeries();
            hideFlightInfo();
            return;
          }

          // é€‰æ‹©ç»ˆç‚¹
          if (selectedCities.from && selectedCities.from !== cityName) {
            selectedCities.to = cityName;
            cityData.selected = true;
            updateSelectionStatus();
            updateSeries();
            drawFlightRoute(selectedCities.from, selectedCities.to);

            // ä»…åœ¨é€‰æ‹©è´µé˜³å’Œæ­å·æ—¶æ˜¾ç¤ºèˆªç­ä¿¡æ¯
            if ((selectedCities.from === 'è´µé˜³' && selectedCities.to === 'æ­å·') ||
                (selectedCities.from === 'æ­å·' && selectedCities.to === 'è´µé˜³')) {
              showFlightInfo(selectedCities.from, selectedCities.to);
            } else {
              hideFlightInfo();
            }
          } else {
            resetSelection();
          }
        } catch (error) {
          console.error('ç‚¹å‡»äº‹ä»¶é”™è¯¯:', error);
          resetSelection();
        }
      });

      // æ›´æ–°ç³»åˆ—æ•°æ®
      function updateSeries() {
        chart.setOption({ series: [{ data: capitalData }] }, { notMerge: false, silent: true });
      }

      // æ›´æ–°é€‰æ‹©çŠ¶æ€æ–‡æœ¬
      function updateSelectionStatus() {
        if (!selectedCities.from) {
          selectionStatus.innerHTML = 'è¯·ç‚¹å‡»é€‰æ‹©ç¬¬ä¸€ä¸ªçœä¼šåŸå¸‚';
        } else if (!selectedCities.to) {
          selectionStatus.innerHTML = `å·²é€‰æ‹©èµ·ç‚¹: ${selectedCities.from}<br>è¯·ç‚¹å‡»é€‰æ‹©ç»ˆç‚¹åŸå¸‚`;
        } else {
          selectionStatus.innerHTML = `å·²é€‰æ‹©: ${selectedCities.from} â†’ ${selectedCities.to}`;
        }
      }

      // ç»˜åˆ¶é£çº¿
      function drawFlightRoute(fromCity, toCity) {
        const fromCoord = capitalCities[fromCity];
        const toCoord = capitalCities[toCity];
        const flightData = [{ fromName: fromCity, toName: toCity, coords: [fromCoord, toCoord] }];
        addFlightRoutes(flightData);
      }

      // æ·»åŠ é£çº¿ç³»åˆ—
      function addFlightRoutes(flightData) {
        clearFlightRoutes();
        chart.setOption({
          series: [
            // ä¿ç•™æ•£ç‚¹ç³»åˆ—
            {
              type: 'effectScatter',
              coordinateSystem: 'geo',
              data: capitalData,
              symbolSize: 7,
              showEffectOn: 'render',
              rippleEffect: { brushType: 'stroke', color: '#00FFFF' },
              label: {
                show: true,
                position: 'right',
                formatter: '{b}',
                textStyle: { color: '#0000FF', fontSize: 12 }
              },
              itemStyle: {
                color: params => params.data.selected ? '#FF44AA' : '#00FFFF',
                shadowBlur: 10,
                shadowColor: '#333'
              },
              zlevel: 2
            },
            // é™æ€é£çº¿
            {
              id: FLIGHT_SERIES_IDS[0],
              type: 'lines',
              coordinateSystem: 'geo',
              zlevel: 3,
              effect: {
                show: true,
                period: 3,
                trailLength: 0,
                symbol: 'arrow',
                color: '#FF1493',
                symbolSize: 8
              },
              lineStyle: {
                color: '#FF1493',
                width: 2,
                opacity: 0.8,
                curveness: 0.3
              },
              data: flightData
            },
            // é£è¡ŒåŠ¨ç”»
            {
              id: FLIGHT_SERIES_IDS[1],
              type: 'lines',
              coordinateSystem: 'geo',
              zlevel: 4,
              effect: {
                show: true,
                period: 6,
                trailWidth: 3,
                trailLength: 0.5,
                trailColor: '#FF1493',
                trailOpacity: 0.9,
                symbol: 'circle',
                symbolSize: 5
              },
              lineStyle: {
                color: 'transparent',
                width: 0,
                curveness: 0.3
              },
              data: flightData
            }
          ]
        }, { notMerge: false, silent: true });
      }

      // æ¸…é™¤é£çº¿
      function clearFlightRoutes() {
        const option = chart.getOption();
        option.series = option.series.filter(series =>
          !FLIGHT_SERIES_IDS.includes(series.id || '')
        );
        chart.setOption(option, { notMerge: true, silent: true });
      }

      // é‡ç½®é€‰æ‹©
      function resetSelection() {
        selectedCities = { from: null, to: null };
        capitalData.forEach(item => item.selected = false);
        clearFlightRoutes();
        chart.setOption(baseOption, { notMerge: true, silent: true });
        updateSelectionStatus();
        hideFlightInfo();
      }

      // æ˜¾ç¤ºèˆªç­ä¿¡æ¯ï¼ˆå·²å»é™¤ä»·æ ¼æ˜¾ç¤ºï¼‰
      function showFlightInfo(fromCity, toCity) {
        const routeKey = `${fromCity}-${toCity}`;
        const routes = flightRoutes[routeKey] || [];

        if (routes.length > 0) {
          flightInfoTitle.textContent = `${fromCity} â†’ ${toCity} èˆªç­ä¿¡æ¯ (6æœˆ30æ—¥)`;

          let html = '';
          routes.forEach((route, index) => {
            const statusColor = route.status === 'å‡†ç‚¹' ? '#008000' : '#FF0000';

            html += `
              <div class="flight-item">
                <div class="flight-header" style="font-weight: bold; color: #2F4F4F;">
                  ${route.airline} ${route.flightNo}
                </div>
                <div class="flight-details" style="margin-top: 5px;">
                  <div style="color: #8B0000;">${fromCity} â†’ ${toCity}</div>
                  <div style="color: #1E90FF; font-size: 16px;">
                    ${route.departureTime} - ${route.arrivalTime}
                  </div>
                  <div style="color: #696969;">æœºå‹: ${route.aircraft}</div>
                  <div style="color: ${statusColor};">çŠ¶æ€: ${route.status}</div>
                </div>
              </div>
            `;
          });

          flightList.innerHTML = html;
          flightInfo.style.display = 'block';
        } else {
          flightInfoTitle.textContent = `${fromCity} â†’ ${toCity} æš‚æ— 6æœˆ30æ—¥èˆªç­ä¿¡æ¯`;
          flightList.innerHTML = '';
          flightInfo.style.display = 'block';
        }
      }

      // éšè—èˆªç­ä¿¡æ¯
      function hideFlightInfo() {
        flightInfo.style.display = 'none';
      }

      // é‡ç½®æŒ‰é’®äº‹ä»¶
      resetBtn.addEventListener('click', resetSelection);

      // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è¡¨
      window.addEventListener('resize', () => chart.resize());
    });
</script>
</body>
</html>
